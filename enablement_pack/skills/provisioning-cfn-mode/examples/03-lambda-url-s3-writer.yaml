AWSTemplateFormatVersion: '2010-09-09'
Description: agent provisioning example 03 (Function URL + S3 writer; runtime provisioning denied by boundary)

Parameters:
  AgentRoleName:
    Type: String
    Description: Must start with the allowlisted prefix derived from cfnExecutionRoleArn (ex: agentawsworkshop-agent-...)
  RequiredBoundaryArn:
    Type: String
    Description: Must equal references.provisioning.requiredRoleBoundaryArn

Resources:
  DataBucket:
    Type: AWS::S3::Bucket

  WriterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref AgentRoleName
      PermissionsBoundary: !Ref RequiredBoundaryArn
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: WriterPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: BucketList
                Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt DataBucket.Arn
              - Sid: ObjectRW
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub "${DataBucket.Arn}/*"
              - Sid: AttemptProvisioningAtRuntime
                Effect: Allow
                Action:
                  # This is intentionally allowed here to demonstrate that a permissions boundary
                  # still blocks provisioning actions for workloads (expect AccessDenied at runtime).
                  - s3:CreateBucket
                Resource: "*"

  WriterFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt WriterRole.Arn
      Timeout: 15
      Environment:
        Variables:
          BUCKET_NAME: !Ref DataBucket
      Code:
        ZipFile: |
          import json
          import os
          import time
          import boto3

          def handler(event, context):
              bucket = os.environ["BUCKET_NAME"]
              region = os.environ.get("AWS_REGION", "us-east-1")
              s3 = boto3.client("s3", region_name=region)

              out = {"bucket": bucket, "region": region, "putObject": None, "createBucket": None}

              key = f"hello/{int(time.time())}.txt"
              try:
                  s3.put_object(Bucket=bucket, Key=key, Body=b"hello from lambda")
                  out["putObject"] = {"ok": True, "key": key}
              except Exception as exc:
                  out["putObject"] = {"ok": False, "key": key, "error": str(exc)}

              rogue_bucket = f"rogue-{context.aws_request_id[:16].lower()}"
              try:
                  params = {"Bucket": rogue_bucket}
                  if region != "us-east-1":
                      params["CreateBucketConfiguration"] = {"LocationConstraint": region}
                  s3.create_bucket(**params)
                  out["createBucket"] = {"ok": True, "bucket": rogue_bucket, "note": "unexpected (boundary misconfigured?)"}
              except Exception as exc:
                  # AccessDenied is expected in this environment.
                  out["createBucket"] = {"ok": False, "bucket": rogue_bucket, "error": str(exc)}

              return {
                  "statusCode": 200,
                  "headers": {"content-type": "application/json"},
                  "body": json.dumps(out),
              }

  WriterFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      TargetFunctionArn: !GetAtt WriterFunction.Arn

  WriterFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunctionUrl
      FunctionName: !Ref WriterFunction
      FunctionUrlAuthType: NONE
      Principal: "*"

  WriterFunctionInvokeViaUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WriterFunction
      Principal: "*"
      InvokedViaFunctionUrl: true

Outputs:
  FunctionUrl:
    Value: !GetAtt WriterFunctionUrl.FunctionUrl
  BucketName:
    Value: !Ref DataBucket
